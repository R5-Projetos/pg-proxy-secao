
define('local_topico_ai_proxy/ui', ['jquery', 'core/ajax', 'core/notification', 'core/str'], function($, Ajax, Notification, Str) {

    var AIButton = {
        init: function(courseId) {
            this.courseId = courseId;
            // Target the secondary navigation tabs (Moodle 4.0+ / RemUI)
            var navTabs = $('.secondary-navigation .nav-tabs, .more-menu .nav-tabs');

            if (navTabs.length) {
                this.renderNavItem(navTabs);
            } else {
                // Fallback to original hero if tabs not found
                var triggerElement = $('.course-hero-img .d-flex.align-items-center');
                if (triggerElement.length) {
                   this.renderButton(triggerElement);
                } else {
                   console.warn('[local_topico_ai_proxy] Could not find navigation tabs or hero section');
                }
            }
        },

        renderNavItem: function(container) {
            var item = $('<li>').addClass('nav-item');
            var link = $('<a>')
                .addClass('nav-link ai-generation-link')
                .attr('href', '#')
                .html('✨ ' + M.str.local_topico_ai_proxy.generate_with_ai)
                .on('click', this.handleClick.bind(this));
            
            item.append(link);
            container.append(item);
        },

        renderButton: function(container) {
            // ... original button render for fallback ...
            var btn = $('<button>')
                .addClass('btn btn-primary ml-2 ai-generation-btn')
                .html('✨ <span class="d-none d-md-inline">' + M.str.local_topico_ai_proxy.generate_with_ai + '</span>')
                .attr('type', 'button')
                .on('click', this.handleClick.bind(this));

            container.append(btn);
        },

        handleClick: function(e) {
            e.preventDefault();
            var target = $(e.currentTarget);
            
            // Confirm dialog
            if (!confirm('Deseja realmente gerar a estrutura do curso com IA? Isso pode alterar tópicos existentes.')) {
                return;
            }

            this.setLoading(target, true);

            Ajax.call([{
                methodname: 'local_topico_ai_proxy_generate_program',
                args: { courseid: this.courseId }
            }])[0]
            .done(function(response) {
                Notification.alert('Sucesso!', 'A estrutura foi gerada. A página será recarregada.', 'OK', function() {
                     window.location.reload();
                });
            })
            .fail(Notification.exception)
            .always(function() {
                AIButton.setLoading(target, false);
            });
        },

        setLoading: function(target, isLoading) {
            if (isLoading) {
                 // Check if it's a link or button
                 if (target.is('a')) {
                     target.addClass('disabled').html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ' + M.str.local_topico_ai_proxy.generating);
                 } else {
                     target.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ' + M.str.local_topico_ai_proxy.generating);
                 }
            } else {
                 if (target.is('a')) {
                     target.removeClass('disabled').html('✨ ' + M.str.local_topico_ai_proxy.generate_with_ai);
                 } else {
                     target.prop('disabled', false).html('✨ <span class="d-none d-md-inline">' + M.str.local_topico_ai_proxy.generate_with_ai + '</span>');
                 }
            }
        }
    };

    return {
        init: function(courseId) {
            AIButton.init(courseId);
        }
    };
});
